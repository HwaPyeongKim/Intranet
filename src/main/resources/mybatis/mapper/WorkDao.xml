<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.intranet.dao.IWorkDao">

    <select id="selectWork" resultType="com.example.intranet.dto.WorkDto">
        select w.*
        , mt.name as workername
        , mf.name as empname
        from work w
        left join member mf on mf.midx = w.midx
        left join member mt on mt.midx = w.worker
        <where>
            w.deleteyn = 'N'
            and worker = #{midx}
            <choose>
                <when test="type == 'title'">
                    and w.title like concat('%', #{key}, '%')
                </when>
                <when test="type == 'titleContent'">
                    and (w.title like concat('%', #{key}, '%') OR w.content like concat('%', #{key}, '%'))
                </when>
                <when test="type == 'name'">
                    and mf.name like concat('%', #{key}, '%')
                </when>
            </choose>
        </where>

        <choose>
            <when test="sort == 'desc'">
                order by w.writedate desc
            </when>
            <when test="sort == 'asc'">
                order by w.writedate asc
            </when>
        </choose>
    </select>

<!--    <select id="getAllCountForWork" resultType="_int">-->
<!--        select count(*) from work_view where title like concat('%', #{key} , '%' ) and worker=#{midx} and deleteyn = 'N'-->
<!--    </select>-->

    <select id="selectYourWork" resultType="com.example.intranet.dto.WorkDto">
        select w.*
        , mt.name as workername
        , mf.name as empname
        from work w
        left join member mf on mf.midx = w.midx
        left join member mt on mt.midx = w.worker
        <where>
            w.deleteyn = 'N'
            and w.midx = #{midx}
            <choose>
                <when test="type == 'title'">
                    and w.title like concat('%', #{key}, '%')
                </when>
                <when test="type == 'titleContent'">
                    and (w.title like concat('%', #{key}, '%') OR w.content like concat('%', #{key}, '%'))
                </when>
                <when test="type == 'name'">
                    and mt.name like concat('%', #{key}, '%')
                </when>
            </choose>
        </where>

        <choose>
            <when test="sort == 'desc'">
                order by w.writedate desc
            </when>
            <when test="sort == 'asc'">
                order by w.writedate asc
            </when>
        </choose>
    </select>

<!--    <select id="getAllCountForYourWork" resultType="_int">-->
<!--        select count(*) from work_view where title like concat('%', #{key} , '%' ) and midx=#{midx} and deleteyn = 'N'-->
<!--    </select>-->

    <insert id="insert" parameterType="com.example.intranet.dto.WorkDto" >
        insert into work( midx, worker, fidx, title, content, status, completedate )
        values( #{midx},#{worker},#{fidx},#{title},#{content}, #{status} ,#{completedate})
    </insert>

    <select id="selectOne" resultType="com.example.intranet.dto.WorkDto">
        select w.*, m.name, f.originalname, f.path
        from work_view w
                 left join member m on m.midx = w.midx
                 left join file f on f.fidx = w.fidx
        where w.widx = #{widx}
    </select>

    <select id="selectComments" resultType="com.example.intranet.dto.WorkCommentDto">
        select wc.*, m.name from work_comment wc
                                     left join member m on m.midx = wc.midx
        where wc.widx = #{widx} and wc.deleteyn = 'N'
        order by wc.writedate desc
    </select>

    <update id="delete">
        update work set deleteyn = 'Y' where widx = #{widx}
    </update>

    <update id="update" parameterType="com.example.intranet.dto.WorkDto">
        update work set
        title = #{title}, content = #{content}, fidx = #{fidx}, completedate = #{completedate} where widx = #{widx}
    </update>

    <insert id="insertComment">
        insert into work_comment (widx, midx, content, autoyn) values (#{widx}, #{midx}, #{content}, #{autoyn})
    </insert>

    <update id="updateComment">
        update work_comment set content = #{content} where wcidx = #{wcidx}
    </update>

    <update id="deleteComment">
        update work_comment set deleteyn = 'Y' where wcidx = #{wcidx}
    </update>

    <update id="changeStatus">
        update work set status = #{next} where widx = #{widx}
    </update>

    <!--  일정관리 수정중에 추가, 유저의 가장 최근 업무를 가져옴   -->
    <select id="getRecentWork" resultType="com.example.intranet.dto.WorkDto">
        select * from work where midx = #{midx} and widx=(
            select MAX(widx) from work
            )
    </select>

    <select id="myCompleteWork" resultType="com.example.intranet.dto.WorkDto">
        select count(*) as totalCount, (select count(*) from work where midx = #{midx} and deleteyn= 'N' and completedate is not null and status = 6) as completeCount

    </select>

</mapper>