<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.intranet.dao.IBoardDao">

    <select id="select" resultType="com.example.intranet.dto.BoardDto">
        select b.*, m.name
        , (select count(*) from board_comment bc where bc.bidx = b.bidx and bc.deleteyn = 'N') as comment_count
        from board b
        left join member m on m.midx = b.midx
        <where>
            b.deleteyn = 'N'
            <if test="category == 'main'">
                and b.category in ('main', 'notice')
            </if>
            <if test="category == 'download'">
                and b.category = 'download'
            </if>

            <if test="type == 'title'">
                and b.title like concat('%', #{key}, '%')
            </if>
            <if test="type == 'titleContent'">
                and (b.title like concat('%', #{key}, '%') OR b.content like concat('%', #{key}, '%'))
            </if>
            <if test="type == 'name'">
                and m.name like concat('%', #{key}, '%')
            </if>
        </where>

        order by
        <choose>
            <when test="sort == 'title'">b.title</when>
            <when test="sort == 'name'">m.name</when>
            <when test="sort == 'readcount'">b.readcount</when>
            <when test="sort == 'showyn'">b.showyn</when>
            <otherwise>b.writedate</otherwise>
        </choose>
        <choose>
            <when test="dir == 'asc'">asc</when>
            <otherwise>desc</otherwise>
        </choose>
    </select>

    <select id="selectOne" resultType="com.example.intranet.dto.BoardDto">
        select b.*, m.name, f.originalname, f.path
        from board b
        left join member m on m.midx = b.midx
        left join file f on f.fidx = b.fidx
        where b.bidx = #{bidx}
    </select>

    <insert id="insert" parameterType="com.example.intranet.dto.BoardDto" useGeneratedKeys="true" keyProperty="bidx">
        insert into board (category, title, content, pwd, midx, fidx) values (#{category}, #{title}, #{content}, #{pwd}, #{midx}, #{fidx})
    </insert>

    <update id="addRead">
        update board set readcount = readcount + 1, reader = #{reader} where bidx = #{bidx} and (find_in_set(#{midx},reader) = 0 or find_in_set(#{midx},reader) is null)
    </update>

    <select id="checkBoardPwd">
        select * from board where bidx = #{bidx} and pwd = #{pwd}
    </select>

    <update id="delete">
        update board set deleteyn = 'Y' where bidx = #{bidx}
    </update>

    <select id="selectNotice" resultType="com.example.intranet.dto.BoardDto">
        select b.*, m.name
        , (select count(*) from board_comment bc where bc.bidx = b.bidx and bc.deleteyn = 'N') as comment_count
        from board b
        left join member m on m.midx = b.midx
        where b.category = 'notice' and b.deleteyn = 'N' and b.showyn = 'Y'
        order by b.writedate desc
    </select>

    <update id="update" parameterType="com.example.intranet.dto.BoardDto">
        update board set category = #{category}, title = #{title}, content = #{content}, midx = #{midx}, fidx = #{fidx}, updatedate = now(), showyn = #{showyn} where bidx = #{bidx}
    </update>

    <select id="selectComments" resultType="com.example.intranet.dto.BoardCommentDto">
        select bc.*, m.name from board_comment bc
        left join member m on m.midx = bc.midx
        where bc.bidx = #{bidx} and bc.deleteyn = 'N'
        order by bc.writedate desc;
    </select>

    <insert id="insertComment">
        insert into board_comment (bidx, midx, content) values (#{bidx}, #{midx}, #{content})
    </insert>

    <update id="updateComment">
        update board_comment set content = #{content} where bcidx = #{bcidx}
    </update>

    <update id="deleteComment">
        update board_comment set deleteyn = 'Y' where bcidx = #{bcidx}
    </update>

</mapper>