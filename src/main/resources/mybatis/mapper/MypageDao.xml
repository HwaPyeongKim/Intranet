<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.intranet.dao.IMypageDao">

    <select id="selectWork" resultType="com.example.intranet.dto.WorkDto">
        select w.*
        , mt.name as workername
        , mf.name as empname
        from work w
        left join member mf on mf.midx = w.midx
        left join member mt on mt.midx = w.worker
        <where>
            w.deleteyn = 'N'
            and worker = #{midx}
            <choose>
                <when test="type == 'title'">
                    and w.title like concat('%', #{key}, '%')
                </when>
                <when test="type == 'titleContent'">
                    and (w.title like concat('%', #{key}, '%') OR w.content like concat('%', #{key}, '%'))
                </when>
                <when test="type == 'name'">
                    and mf.name like concat('%', #{key}, '%')
                </when>
            </choose>
        </where>

        order by
        <choose>
            <when test="sort == 'title'">w.title</when>
            <when test="sort == 'empname'">mf.name</when>
            <when test="sort == 'deadline'">w.deadline</when>
            <when test="sort == 'status'">w.status</when>
            <otherwise>w.writedate</otherwise>
        </choose>
        <choose>
            <when test="dir == 'asc'">asc</when>
            <otherwise>desc</otherwise>
        </choose>
    </select>

    <select id="selectRequests" resultType="com.example.intranet.dto.MemberRequestsDto">
        select mr.*, m.name, cm.name as cname
        from member_requests mr
        left join member m on m.midx = mr.midx
        left join member cm on cm.midx = mr.confirm_midx
        <where>
            mr.deleteyn = 'N'
            and mr.midx = #{midx}
            <choose>
                <when test="type == 'title'">
                    and mr.title like concat('%', #{key}, '%')
                </when>
                <when test="type == 'titleContent'">
                    and (mr.title like concat('%', #{key}, '%') OR mr.content like concat('%', #{key}, '%'))
                </when>
                <when test="type == 'cname'">
                    and cm.name like concat('%', #{key}, '%')
                </when>
            </choose>
        </where>

        order by
        <choose>
            <when test="sort == 'category'">mr.category</when>
            <when test="sort == 'title'">mr.title</when>
            <when test="sort == 'cname'">cm.name</when>
            <when test="sort == 'startdate'">mr.startdate</when>
            <when test="sort == 'enddate'">mr.enddate</when>
            <when test="sort == 'status'">mr.status</when>
            <otherwise>mr.writedate</otherwise>
        </choose>
        <choose>
            <when test="dir == 'asc'">asc</when>
            <otherwise>desc</otherwise>
        </choose>
    </select>

    <insert id="insertRequests" parameterType="com.example.intranet.dto.MemberRequestsDto">
        insert into member_requests (category, midx, title, content, startdate, enddate, confirm_midx) values (#{category} , #{midx} , #{title} , #{content} , #{startdate} , #{enddate}, #{confirm_midx})
    </insert>

    <select id="selectConfirm" resultType="com.example.intranet.dto.MemberDto">
        select * from member where deleteyn = 'N' and leavedate is null and  team = (select team from member where midx = #{midx}) and midx != #{midx}
    </select>

</mapper>