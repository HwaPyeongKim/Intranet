<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.intranet.dao.IMemberDao">

    <insert id="insert" parameterType="com.example.intranet.dto.MemberDto">
        insert into member (name, userid, pwd, number, email, phone, image, postcode, address1, address2) values (#{name}, #{userid}, #{pwd}, #{number}, #{email}, #{phone}, #{image}, #{postcode}, #{address1}, #{address2})
    </insert>

    <select id="getMember" resultType="com.example.intranet.dto.MemberDto">
        select m.*, t.name as teamname
        from member m
        left join team t on t.tidx = m.team
        where m.userid = #{userid}
    </select>

    <select id="selectMember" resultType="com.example.intranet.dto.MemberDto">
        select * from member where midx = #{midx}
    </select>

    <insert id="insertAttendance">
        insert into member_attendance (midx) values (#{midx})
    </insert>

    <select id="selectAttendance" resultType="com.example.intranet.dto.MemberAttendanceDto">
        select * from member_attendance where midx = #{midx} and date = #{date}
    </select>

    <update id="workout">
        update member_attendance set endtime = now() where midx = #{midx} and date = #{date} and endtime is null
    </update>

    <select id="checkWorkout" resultType="com.example.intranet.dto.MemberAttendanceDto">
        select midx, starttime, date_format(endtime, '%Y-%m-%d %H:%i:%s') AS endtime from member_attendance where midx = #{midx} and date = #{date} and endtime is not null
    </select>

    <select id="getAllMembers" resultType="com.example.intranet.dto.MemberDto">
        select * from member
    </select>

    <select id="checkPwd" resultType="com.example.intranet.dto.MemberDto">
        select * from member where userid = #{userid} and pwd = #{pwd}
    </select>

    <update id="update" parameterType="com.example.intranet.dto.MemberDto">
        update member set name = #{name}, email = #{email}, phone = #{phone}, postcode = #{postcode}, address1 = #{address1}, address2 = #{address2}, image = #{image} where midx = #{midx}
    </update>

    <update id="changePwd">
        update member set pwd = #{pwd} where midx = #{midx}
    </update>

    <select id="selectMembers" resultType="com.example.intranet.dto.MemberDto">
        select *
        from member m
        <where>
            m.deleteyn = 'N'
            <if test="level == 2">
                and m.team = (select team from member where midx = #{midx})
            </if>

            <choose>
                <when test="type == 'userid'">
                    and m.userid like concat('%', #{key}, '%')
                </when>
                <when test="type == 'name'">
                    and m.name like concat('%', #{key}, '%')
                </when>
                <when test="type == 'email'">
                    and m.email like concat('%', #{key}, '%')
                </when>
            </choose>
        </where>

        order by
        <choose>
            <when test="sort == 'position'">m.position</when>
            <when test="sort == 'name'">m.name</when>
            <when test="sort == 'leavedate'">m.leavedate</when>
            <when test="sort == 'confirmyn'">m.confirmyn</when>
            <otherwise>m.joindate</otherwise>
        </choose>
        <choose>
            <when test="dir == 'asc'">asc</when>
            <otherwise>desc</otherwise>
        </choose>
    </select>

    <select id="checkNewMessage" resultType="_int">
        select count(*) from message where tomidx = #{midx} and readyn = 'N' and todeleteyn = 'N' and fromdeleteyn = 'N'
    </select>

    <select id="selectMemberAttendances" resultType="com.example.intranet.dto.MemberAttendanceDto">
        select ma.*
        , m.name
        from member_attendance ma
        left join member m on m.midx = ma.midx
        <where>
            date between #{startdate} and #{enddate}
            <if test="level == 2">
                and m.team = (select team from member where midx = #{midx})
            </if>


            <choose>
                <when test="type == 'name'">
                    and m.name like concat('%', #{key}, '%')
                </when>
            </choose>

            order by
            <choose>
                <when test="sort == 'name'">m.name</when>
                <when test="sort == 'starttime'">ma.starttime</when>
                <when test="sort == 'endtime'">ma.endtime</when>
                <otherwise>ma.date</otherwise>
            </choose>
            <choose>
                <when test="dir == 'asc'">asc</when>
                <otherwise>desc</otherwise>
            </choose>
        </where>
    </select>

<!-- @@@@@@@ main @@@@@@@ -->
    <select id="selectInOutTime" resultType="com.example.intranet.dto.MemberAttendanceDto">
        SELECT * FROM member_attendance WHERE midx = #{midx} and date = #{today}
    </select>

    <select id="selectMyReqList" resultType="com.example.intranet.dto.MemberRequestsDto">
        select * from member_requests where confirm_midx = #{midx} and status = 1 order by ridx desc limit 5
    </select>

    <select id="selectMyWorkList" resultType="com.example.intranet.dto.WorkDto">
        select *
        , date_format(completedate, '%Y-%m-%d') as cdate
        from work where worker = #{midx} and status = 1 order by completedate limit 5
    </select>

    <select id="selectMainNotice" resultType="com.example.intranet.dto.BoardDto">
        select * from board where category = 'notice' order by writedate desc limit 1
    </select>



</mapper>