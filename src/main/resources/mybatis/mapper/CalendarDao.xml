<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.intranet.dao.calendar.ICalendarDao">

    <!--
        원본 https://greed-yb.tistory.com/274
        DB 이름을 기존의 schedule로 할지 원본의 calendar로 할지 선택필요
        공통 수정사항
        파일명 mapper.xml -> CalendarDao.xml
        패키지명 변경
        CALENDAR_NO 에 AS calendarNo 추가
        ALL_DAY 에 AS allDay 추가
    -->


    <!-- 일정 조회하기-->
    <!--
        수정사항
        TO_CHAR()를 DATE_FORMAT()로 변경
        where에 midx 추가
        카테고리기능 추가, 카테고리별 수정가능여부, 색상 추가
        부서일정의 경우 해당 부서 직원만 부서일정이 보이게?
    -->
    <select id="calendarList" resultType="com.example.intranet.dto.calendar.CalendarDto" parameterType="com.example.intranet.dto.MemberDto">
        SELECT CALENDAR_NO                                      AS calendarNo,
               CALENDAR_TITLE                                   AS TITLE,
               DATE_FORMAT(CALENDAR_START, '%Y-%m-%d %H:%i:%s') AS START1,
               DATE_FORMAT(CALENDAR_END, '%Y-%m-%d %H:%i:%s') AS END,
            ALL_DAY AS allDay,
            category,
            editable,
            eventColor
        FROM CALENDAR
        WHERE (category=1 AND midx = #{midx}) OR (category=2 AND tidx = #{team}) OR category=3  -- 유저의 개인일정, 부서일정, 회사전체일정을 가져옵니다
        order by category desc;
    </select>

    <!-- 일정 저장하기 -->
    <!-- 저장하고 생성된 no(key) 값을 return 시킨다 -->
    <!--
        수정사항
        TO_DATE()를 DATE_FORMAT()로 변경
        Auto Increment 추가로 CALENDAR_NO를 인서트 하는 부분을 지움
        유저의 midx를 같이 insert
    -->
    <insert id="calendarSave" parameterType="com.example.intranet.dto.calendar.CalendarDto" useGeneratedKeys="true"
            keyColumn="CALENDAR_NO" keyProperty="calendarNo">
        INSERT INTO CALENDAR(CALENDAR_TITLE,    -- 제목
                             CALENDAR_START,    -- 시작일
                             CALENDAR_END,      -- 종료일
                             ALL_DAY,           -- 하루종일 true or false
                             MIDX,              -- 일정 작성자
                             category,          -- 개인 or 부서 or 회사 일정
                             editable,          -- 일정 수정 가능여부
                             eventColor,        -- 일정 카테고리에 따른 일정 색깔
                             widx,              -- 업무와 연결되는 경우 업무 idx 입력
                             tidx,              -- 부서일정인 경우 부서 idx 입력
                             ridx               -- 휴가인 경우 결재서류 idx 입력
        )
        values (#{title},
                DATE_FORMAT(#{start1}, '%Y-%m-%d %H:%i:%s'),
                DATE_FORMAT(#{end}, '%Y-%m-%d %H:%i:%s'),
                #{allDay},
                #{midx},
                #{category},
                #{editable},
                #{eventColor},
                #{widx},
                #{tidx},
                #{ridx})
    </insert>

    <!-- 일정 삭제하기 -->
    <delete id="calendarDelete">
        DELETE
        FROM CALENDAR
        WHERE CALENDAR_NO = #{no}
    </delete>


    <!-- 일정 수정하기 -->
    <!--
        수정사항
        TO_DATE()를 DATE_FORMAT()로 변경
    -->
    <update id="eventUpdate" parameterType="com.example.intranet.dto.calendar.CalendarDto">
        UPDATE CALENDAR
        SET CALENDAR_TITLE = #{title},
            CALENDAR_START = DATE_FORMAT(#{start1}, '%Y-%m-%d %H:%i:%s'),
            CALENDAR_END   = DATE_FORMAT(#{end}, '%Y-%m-%d %H:%i:%s'),
            ALL_DAY        = #{allDay}
        WHERE CALENDAR_NO = #{calendarNo}
    </update>

    <!--  업무와 연결된 일정 가져오기  -->
    <select id="getEventForWork" resultType="com.example.intranet.dto.calendar.CalendarDto">
        SELECT CALENDAR_NO                                      AS calendarNo,
               CALENDAR_TITLE                                   AS TITLE,
               DATE_FORMAT(CALENDAR_START, '%Y-%m-%d %H:%i:%s') AS START1,
               DATE_FORMAT(CALENDAR_END, '%Y-%m-%d %H:%i:%s') AS END,
            ALL_DAY AS allDay,
            category,
            editable,
            eventColor
        from calendar where widx = #{widx}
    </select>

    <!--  오래된 자동생성일정, 완료된 자동생성일정 자동삭제하기, 일정 리스트를 불러올때마다 실행  -->
    <delete id="deleteOldEvent">
        delete c
        from calendar c, work w
        where (c.CALENDAR_END &lt; now() AND (c.ridx>=1 OR c.widx>=1 )) -- &lt; : 부등호 왼쪽이 작다 기호, 에러걸려서 바꿈
            OR (c.widx=w.widx AND w.status=6)
            OR (c.widx=w.widx AND w.deleteyn='Y')
            OR (c.widx>=1 and c.widx != ANY (
                select w.widx from(
                    select w.widx from work w, calendar c where w.widx=c.widx
                )as w)
            );
        -- 삭제하는 것들
        -- ridx나 widx가 있는 일정중 일정 종료일이 현재시간 이전인 것들
        -- 완료된 업무의 자동생성 일정
        -- 삭제된 업무 (휴가 취소의 경우는 고려안됨, 이경우 관리자가 삭제할수는 있음)
        -- calendar DB의 widx 값이 work DB에는 없는경우 (주로 sql 파일 임포트하면서 기존 업무 DB를 날렸을 경우 상황발생)
    </delete>
</mapper>